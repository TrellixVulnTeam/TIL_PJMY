# 0413 수요일 DB 02

![image-20220418015736535](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418015736535.png)

* 1 : N 관계에서 외래키는 N이 가지게 됨
* 참조하는 모델 (Comments)에서 외래키는 참조되는 모델(Article)의 기본키를 가짐
*  참조 

![image-20220418020756515](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418020756515.png)





## FK의 특징

* 키를 사용하여 부모 테이블의 유일한 값을 참조 (참조 무결성)

<img src="C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418021039653.png" alt="image-20220418021039653" style="zoom:50%;" />

* 외래 키의 값이 반드시 부모 테이블의 기본키일 필요는 없지만 유일한 값이어야 함

![image-20220418021202548](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418021202548.png)  



![image-20220418021651976](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418021651976.png)

* 외래 키가 참조하는 객체가 사라졌을 때 외래 키를 가진 객체를 어떻게 처리할 지를 정의
* cascade : 부모객체가 삭제 됐을 때 참조하는 객체도 같이 삭제 됨 
* 데이터 무결성 : 정확성 , 일관성 유지
  * 개체 무결성 : PK와 관련 , 모든 테이블이 PK를 가져야 하며 PK는 고유한 값, 빈 값 허용 X
  * 참조 무결성 : FK와 관련,  FK 값이 데이터베이스의 특정 테이블의 PK 값을 참조하는 것
  * 도메인 무결성



---

## FK 모델 정의 

``` bash
$ python manage.py makemigrations

$ python manage.py migrate

--> article_id 로 PK가 만들어져 있음 (_id)
```

![image-20220418022250720](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418022250720.png)

 

###  comment 모델은 외래키 article_id를 포함합니다.

![image-20220418022441248](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418022441248.png)

* 변수명은 소문자 단수형 article 로 써야함 article_id는 틀림 

* 단수형의 의미는 두가지

  * 누굴 참조하는지
  * 1:N 관계의 외래키인지,  M:N 관계의 외래키인지 알 수 있음

  

  

  

  

## 댓글 생성 연습하기

![image-20220418022959411](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418022959411.png)

* comment에 필요한 것은 : 댓글 내용, 어떤 게시글에 달린 건지 총 두개가 필요

![image-20220418023234008](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418023234008.png)

* 아래 것으로  넣어야 함

``` sql
$ python manage.py shell_plus

# Comment()클래스를 이용해서 comment인스턴스를 생성
In [1]: comment = Comment()

# 
In [2]: comment.content = 'first comment'

# 저장
In [3]: comment.save()

--> 에러가 남

#  article이 없어서 빠르게 하나 만듦
In [4]: article = Article.objects.create(title='title', content='content')

# 
In [5]: comment.article = article

# 저장
In [6]: comment.save()

# 
In [7]: comment.pk = 1

# 참조하는 대상을 리턴할 수 있음
In [8]: comment.article
Out [8]: <Article: title>

# 이 게시글 몇번 글이야?
In [9]: comment.article_id   #물리적인 필드
In [9]: comment.article.pk   #객체 접근
Out [9]: 1


In [9]: comment.article_pk   #이건 안됨!!!


# 이 게시글 내용이 뭐야?
In [10]: comment.article.content
Out [10]: 'content'

-->

# 한 번에 넣어주기
In [11]: comment = Comment(content='second comment', article=article)

# 두번째 글 저장
In [12]: comment.save()


```

![image-20220418022918156](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418022918156.png)

![image-20220418023040986](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418023040986.png)



* 결과

![image-20220418023335210](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418023335210.png)



* 1번 댓글은 1번 게시물에 달려 있는 댓글이다.

![image-20220418023434784](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418023434784.png)



* 참조하는 대상을 return 할 수 있음

![image-20220418023519375](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418023519375.png)

comment는 물리적인 외래키를 들고 있기 때문에 article 객체를 참조할 수 있고 article객체의 값도 불러올 수 있음

![image-20220418024008588](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418024008588.png)

article_pk는 안됨



## 관리자 등록 (admin)

![image-20220418024052667](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418024052667.png)



``` bash
# admin 계정 만들기
$ python manage.py createsuperuser
```





## 1:N관계 related manager (역참조)

![image-20220418024853060](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418024853060.png)



 

![image-20220418024412821](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418024412821.png)



![image-20220418024454400](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418024454400.png)



dir()함수로 인스턴스의 

article.comment  는 당연히 안됨

article.comment_set

![image-20220418025027171](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025027171.png)





![image-20220418025138616](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025138616.png)



``` sqlite
# 역참조
In [1]: comments = article.comment_set.all()

```

![image-20220418025315218](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025315218.png)



1 :N관계에서 바꿀수는 있지만 권장 X 

M :N 관계에서는 이렇게 써야할 경우가 생길 수 가 있음 

![image-20220418025626223](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025626223.png)





## Comment CREATE

### 0. Import

![image-20220418033601155](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033601155.png)



### 1. form작성

![image-20220418025723217](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025723217.png)

### 2. view 작성

![image-20220418025802657](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025802657.png)

* 수업에서는 데코레이터 씀

![image-20220418025855033](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025855033.png)

### 3. template 작성

![image-20220418025918622](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025918622.png)

![image-20220418025930716](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418025930716.png)



## 수정 

![image-20220418030136232](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418030136232.png)



![image-20220418031203395](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418031203395.png)

일단 이렇게 쓰고 저장해보기

![image-20220418031235353](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418031235353.png)

그래서 바로 save하지 않고, article(FK)의 값을 넣어주는것

![image-20220418030402781](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418030402781.png)



![image-20220418030418372](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418030418372.png)



detail에서 넘어온 댓글은 단독페이지가없어서 post로 충분하다 

![image-20220418031506607](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418031506607.png)



### 시행착오

![image-20220418031657671](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418031657671.png)

1. 필드의 출력 부분 : 댓글 작성엔 두개 값이 필요한데, 외래키는 사용자한테 안받아도됨(지금 구조상 받아서는 안되는 값)

![image-20220418031741549](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418031741549.png)

2. 그럼 외래키는 어디서 받아? 뷰함수에서 commit=False

`create, but don't save the new instance`

![image-20220418032123956](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032123956.png)





## Comment READ : detail에서 출력

![image-20220418032245498](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032245498.png)

![image-20220418032345466](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032345466.png)



### template

![image-20220418032405760](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032405760.png)









## Comment DELETE

### urls.py

![image-20220418032541791](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032541791.png)



### views

detail 페이지로 가려면 article.pk가 필요한데, 방법이 두가지가 있다

1. view에서 참조

![image-20220418032946959](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418032946959.png)



2. variable routing --> 이유는, url 일관성 유지

![image-20220418033045892](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033045892.png)



![image-20220418033150208](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033150208.png)





### detail

* action 부분 잘 채워야함

![image-20220418033431854](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033431854.png)

![image-20220418033452157](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033452157.png)





### 인증시스템 커스텀

![image-20220418033936994](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418033936994.png)



![image-20220418034405232](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418034405232.png)

![image-20220418034427790](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418034427790.png)



## Substituting a custom User model

* AITH_USER_MODEL은 settings.py에 있는 값을 제공
* 모든 migrations 혹은 첫 migrate 진행전에 대체해야함

![image-20220418035100869](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035100869.png)



#### AUTH_USER_MODEL

![image-20220418035225576](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035225576.png)



![image-20220418035207279](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035207279.png)



![image-20220418035243007](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035243007.png)

settings.py에서 이걸 우리 프로젝트 모델로 바꾸고 시작해야함





#### User는 AbstractUser를 상속받고 있음



![image-20220418035436100](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035436100.png)

![image-20220418035502462](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035502462.png)





#### User정의 (migrations전에 해야함) 커스텀 안해도 해야함

![image-20220418035655249](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035655249.png)

![image-20220418035741064](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035741064.png)



숫자 붙은 설계도만 지워야함

![image-20220418035902020](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035902020.png)

![image-20220418035845400](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418035845400.png)



![image-20220418040204548](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418040204548.png)



* 사용자(들) 사라짐

![image-20220418040643906](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418040643906.png)

![image-20220418040714504](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418040714504.png)



![image-20220418040742055](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418040742055.png)

![image-20220418041108570](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041108570.png)



## Custom user & Buit in auth forms

* 회원가입이 안됨

![image-20220418041311602](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041311602.png)

![image-20220418041331342](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041331342.png)

회원가입, 회원정보 수정에서 

![image-20220418041412379](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041412379.png)

![image-20220418041442673](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041442673.png)



* 현재 장고 모델에 메인으로 활성화된 유저모델 리턴 : get_user_model

![image-20220418041555413](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041555413.png)



![image-20220418041728454](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041728454.png)



![image-20220418041708361](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041708361.png)

![image-20220418041846706](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041846706.png)

![image-20220418041924111](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418041924111.png)

직접 참조 X

직접 참조의 문제점은 유저를 대체하니까 바로 문제가 생겼었음 



### User - Article

![image-20220418042320846](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418042320846.png)



fk : 참조하는 모델이름의 소문자 단수형 user

![image-20220418042507480](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418042507480.png)



![image-20220418042727732](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418042727732.png)

결론만 외우기

![image-20220418043117628](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043117628.png)

이런과정을 거치는데, 1번을 할 때 get_user_model()로 하면 반환이 안될수도 있어서 

문자열로 하려고 !!



![image-20220418043330812](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043330812.png)

![image-20220418042600462](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418042600462.png)

 

![image-20220418042647445](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418042647445.png)



![image-20220418043505557](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043505557.png)



![image-20220418043523637](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043523637.png)

다 admin으로 바꾸겠다.

![image-20220418043548193](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043548193.png)



![image-20220418043608326](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043608326.png)



![image-20220418043618624](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043618624.png)![image-20220418043710971](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043710971.png)

 

![image-20220418043632710](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043632710.png)

![image-20220418043644015](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043644015.png)

![image-20220418043655146](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418043655146.png)

![image-20220418044155177](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044155177.png)



![image-20220418044209416](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044209416.png)

![image-20220418044728095](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044728095.png)



![image-20220418044247933](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044247933.png)



request를 쓸 수 있는 이유는 settings.py에 TEMPLATES에 제공하고 있음

![image-20220418044820550](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044820550.png)









### User - Comment



![image-20220418044951330](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044951330.png)

![image-20220418044923367](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418044923367.png)



 

![image-20220418045230567](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045230567.png)

![image-20220418045328040](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045328040.png)

![image-20220418045345751](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045345751.png)



![image-20220418045432472](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045432472.png)



![image-20220418045447476](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045447476.png)





![image-20220418045814980](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045814980.png)

![image-20220418045758522](C:\Users\star3\AppData\Roaming\Typora\typora-user-images\image-20220418045758522.png)





